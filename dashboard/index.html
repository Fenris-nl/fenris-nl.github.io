<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Widget Analytics Dashboard</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <h1>üìä Widget Analytics</h1>
    <p>Usage statistics for the Spotify Widget</p>
  </header>

  <main>
    <section class="card" id="setup-required">
      <h2>‚öôÔ∏è Setup Required</h2>
      <p>To enable analytics, you need to:</p>
      <ol>
        <li>Create a Google Sheet and deploy the Apps Script (see instructions below)</li>
        <li>Update the <code>APPS_SCRIPT_URL</code> in <code>/script.js</code> and <code>/dashboard/script.js</code></li>
      </ol>
      <p>Once configured, this message will disappear and your stats will appear.</p>
    </section>

    <section class="stats-grid" id="stats-container" style="display: none;">
      <div class="stat-card">
        <div class="stat-number" id="totalLoads">-</div>
        <div class="stat-label">Total Loads</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="uniqueUsers">-</div>
        <div class="stat-label">Unique Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="loadsToday">-</div>
        <div class="stat-label">Loads Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="loadsThisWeek">-</div>
        <div class="stat-label">Loads This Week</div>
      </div>
    </section>

    <section class="card" id="recent-activity" style="display: none;">
      <h2>üìà Recent Activity</h2>
      <table id="activityTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>User (hashed)</th>
          </tr>
        </thead>
        <tbody id="activityBody">
        </tbody>
      </table>
    </section>

    <section class="card">
      <h2>üìã Setup Instructions</h2>
      <details>
        <summary>Step 1: Create a Google Sheet</summary>
        <ol>
          <li>Go to <a href="https://sheets.google.com" target="_blank">Google Sheets</a> and create a new spreadsheet</li>
          <li>Name it something like "Widget Analytics"</li>
          <li>In cell A1, type <code>Timestamp</code></li>
          <li>In cell B1, type <code>UserHash</code></li>
        </ol>
      </details>
      <details>
        <summary>Step 2: Add the Apps Script</summary>
        <ol>
          <li>In your Google Sheet, go to <strong>Extensions ‚Üí Apps Script</strong></li>
          <li>Delete any existing code and paste this:</li>
        </ol>
        <pre><code id="appsScriptCode">function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    sheet.appendRow([new Date(), data.userHash || 'unknown']);
    return ContentService.createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({error: err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    // Skip header row
    const rows = data.slice(1);
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekStart = new Date(todayStart);
    weekStart.setDate(weekStart.getDate() - 7);
    
    const uniqueUsers = new Set();
    let loadsToday = 0;
    let loadsThisWeek = 0;
    
    const recentRows = [];
    
    rows.forEach(row => {
      const timestamp = new Date(row[0]);
      const userHash = row[1];
      uniqueUsers.add(userHash);
      
      if (timestamp >= todayStart) loadsToday++;
      if (timestamp >= weekStart) loadsThisWeek++;
    });
    
    // Get last 20 entries for recent activity
    const last20 = rows.slice(-20).reverse().map(row => ({
      timestamp: row[0],
      userHash: String(row[1]).substring(0, 12) + '...'
    }));
    
    const result = {
      totalLoads: rows.length,
      uniqueUsers: uniqueUsers.size,
      loadsToday: loadsToday,
      loadsThisWeek: loadsThisWeek,
      recentActivity: last20
    };
    
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({error: err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
      </details>
      <details>
        <summary>Step 3: Deploy as Web App</summary>
        <ol>
          <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
          <li>Click the gear icon and select <strong>Web app</strong></li>
          <li>Set "Execute as" to <strong>Me</strong></li>
          <li>Set "Who has access" to <strong>Anyone</strong></li>
          <li>Click <strong>Deploy</strong></li>
          <li>Copy the Web app URL (looks like <code>https://script.google.com/macros/s/ABC.../exec</code>)</li>
        </ol>
      </details>
      <details>
        <summary>Step 4: Update your code</summary>
        <ol>
          <li>Open <code>/script.js</code> and find <code>APPS_SCRIPT_URL</code> near the top</li>
          <li>Replace the placeholder with your Web app URL</li>
          <li>Open <code>/dashboard/script.js</code> and do the same</li>
          <li>Commit and push your changes</li>
        </ol>
      </details>
    </section>
  </main>

  <footer>
    <small>Analytics data is stored in your Google Sheet. Only hashed user IDs are logged.</small>
  </footer>

  <script src="./script.js"></script>
</body>
</html>
